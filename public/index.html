<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–û–Ñ –ö–Ü–ù–û ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –±–∞–∑–∞ —Ñ—ñ–ª—å–º—ñ–≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
:root{
  --bg:#0f1115; --card:#161a22; --muted:#9aa4b2; --text:#e6e9ef;
  --brand:#f6c177; --accent:#7aa2f7; --border:rgba(255,255,255,.08);
  --radius:12px; --btn-h:40px; --btn-gap:8px;
  --btn-bg:var(--card); --btn-bdr:var(--border);
  --btn-hover:rgba(122,162,247,.18);
  --danger:rgba(255,110,110,.22);
  --danger-b:rgba(255,110,110,.38);
  --heart:#ff5c7a;
}

*{box-sizing:border-box}
html,body{
  height:100%;min-height:100vh;margin:0;padding:0;
  background:linear-gradient(180deg,#0e1014,#121521);
  background-attachment:fixed;
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
}

/* ===== –®–ê–ü–ö–ê ===== */
header{
  position:sticky;top:0;z-index:10;
  backdrop-filter:blur(8px);
  background:linear-gradient(180deg,rgba(20,22,28,.9),rgba(20,22,28,.65));
  border-bottom:1px solid var(--border);
}
.nav{
  max-width:1200px;margin:auto;padding:12px 16px;
  display:flex;gap:12px;align-items:center;
}
.brand{
  font-weight:800;font-size:18px;
  padding:8px 12px;border-radius:12px;
  background:linear-gradient(90deg,var(--brand),#ffd39f);
  color:#1b1b1b;
}
.subtitle{
  color:#000;font-size:12px;margin-left:6px;
}
.search{
  flex:1;display:flex;gap:8px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 12px;
}
.search input{
  flex:1;background:transparent;border:0;color:var(--text);
}

/* ===== –ö–ù–û–ü–ö–ò ===== */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  height:var(--btn-h);padding:0 14px;border-radius:var(--radius);
  border:1px solid var(--btn-bdr);background:var(--btn-bg);color:var(--text);
  font-weight:600;line-height:1;
  transition:border-color .15s,box-shadow .15s,background .15s,transform .05s;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
  user-select:none;
}
.btn:hover{
  border-color:rgba(122,162,247,.45);
  background:var(--btn-hover);
}
.btn:active{transform:translateY(1px)}
.btn.primary{
  background:linear-gradient(90deg,var(--accent),#9fc3ff);
  color:#0c1222;border:0;
  box-shadow:0 6px 10px rgba(122,162,247,.15);
}
.btn.primary:hover{filter:brightness(.98)}
.btn[data-edt],.btn[data-del]{width:var(--btn-h);padding:0}
.btn[data-del]{border-color:var(--danger-b)}
.btn[data-del]:hover{background:var(--danger)}
.actions,.movie>div:last-child{
  display:flex;gap:var(--btn-gap);align-items:center;
}
.heart{
  width:var(--btn-h);height:var(--btn-h);
  display:grid;place-items:center;
  padding:0;border-radius:var(--radius);
  border:1px solid var(--btn-bdr);
  background:var(--btn-bg);color:var(--text);
  transition:background .15s,border-color .15s,transform .05s;
}
.heart:hover{
  background:rgba(255,96,125,.12);
  border-color:rgba(255,96,125,.35);
}
.heart:active{transform:translateY(1px)}
.heart.fav{
  color:var(--heart);border-color:rgba(255,96,125,.45);
  box-shadow:inset 0 0 0 1px rgba(255,96,125,.25);
  background:rgba(255,96,125,.1);
}

/* ===== –ö–ù–û–ü–ö–ò –ú–ê–õ–Ü ===== */
.btn.small{
  height:28px;
  padding:0 10px;
  font-size:11px;
}

/* ===== –ö–û–ù–¢–ï–ô–ù–ï–† ===== */
.container{
  max-width:1200px;margin:20px auto;padding:0 16px;
}
.summary{
  color:var(--muted);margin:8px 0 16px;
}

/* ===== –ö–û–õ–û–ù–ö–ò ===== */
.cols{
  display:grid;grid-template-columns:1fr 1fr;
  gap:20px;align-items:start;
}
@media(max-width:900px){.cols{grid-template-columns:1fr}}
.cols>section{
  display:flex;flex-direction:column;
  height:70vh;min-height:520px;
}
h2{margin:0 0 8px}
.sub{color:var(--muted);font-size:13px;margin-bottom:10px}
.list{
  flex:1;overflow:auto;padding-right:6px;
  border:1px solid var(--border);border-radius:12px;
  background:rgba(255,255,255,.02);
}

/* ===== –ö–ê–†–¢–ö–ò –§–Ü–õ–¨–ú–Ü–í ===== */
.movie{
  display:grid;grid-template-columns:auto 1fr auto;
  gap:12px;align-items:start;
  padding:12px;border-bottom:1px solid var(--border);
}
.movie:last-child{border-bottom:none}
.movie.watched{box-shadow:0 0 0 1px rgba(246,193,119,.25) inset}
.poster{
  width:62px;aspect-ratio:2/3;border-radius:8px;
  object-fit:cover;background:#0c0f16;
  border:1px solid rgba(255,255,255,.12);
}
.title{font-weight:700}
.meta{font-size:12px;color:var(--muted)}
.stars{font-size:16px;letter-spacing:1px;cursor:pointer}
.chip{
  display:inline-flex;gap:6px;align-items:center;
  padding:4px 8px;border-radius:999px;font-size:12px;
  background:rgba(122,162,247,.15);
  border:1px solid rgba(122,162,247,.35);
  margin-top:6px;
}
.empty{
  color:var(--muted);border:1px dashed var(--border);
  border-radius:12px;padding:14px;text-align:center;margin:10px;
}

/* ===== –£–õ–Æ–ë–õ–ï–ù–Ü ===== */
.recent{margin-top:28px}
details{
  background:rgba(255,255,255,.03);
  border:1px solid var(--border);
  border-radius:12px;padding:10px 12px;
}
summary{cursor:pointer;font-weight:600}

/* ===== –ú–û–î–ê–õ–ö–ò –Ü –¢–û–°–¢ ===== */
.backdrop{
  position:fixed;inset:0;display:none;place-items:center;
  background:rgba(0,0,0,.55);backdrop-filter:blur(6px);
  z-index:50;
}
.backdrop.show{display:grid}
.modal{
  width:min(560px,92vw);
  background:#151922;
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
}
.grid{display:grid;gap:10px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input,textarea{
  width:100%;padding:10px 12px;
  border-radius:10px;border:1px solid var(--border);
  background:rgba(255,255,255,.02);color:var(--text);
}
label{font-size:13px;color:var(--muted)}
.section-h3{margin:18px 0 8px}
.toast{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  background:#1a2230;
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:10px;
  display:none;
  z-index:9999; 
}

.toast.show{display:block}

/* ===== –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø / –ú–û–í–ò ===== */
.auth-box{
  display:flex;
  align-items:center;
  gap:10px;
  margin-left:12px;
}
.user-email{
  font-size:13px;
  color:var(--muted);
  max-width:180px;
  white-space:nowrap;
  text-overflow:ellipsis;
  overflow:hidden;
}
.lang-switch{
  display:flex;
  gap:4px;
}
.lang-switch .btn.small{
  opacity:0.7;
}
.lang-switch .btn.small.active{
  opacity:1;
  border-color:var(--accent);
  box-shadow:0 0 0 1px rgba(122,162,247,.5);
}
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">
      –ú–û–Ñ –ö–Ü–ù–û <span class="subtitle" id="subtitle">–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –±–∞–∑–∞ —Ñ—ñ–ª—å–º—ñ–≤</span>
    </div>

    <div class="search">
      <span>üîé</span>
      <input id="q" placeholder="–ü–æ—à—É–∫ —É –Ω–∞–∑–≤—ñ/–∂–∞–Ω—Ä—ñ/—Ä–æ—Ü—ñ..." />
    </div>

    <div class="auth-box">
      <div class="lang-switch">
        <button class="btn small" id="langUk">UA</button>
        <button class="btn small" id="langPl">PL</button>
      </div>
      <span id="userEmail" class="user-email" style="display:none;"></span>
      <button class="btn" id="authBtn">–£–≤—ñ–π—Ç–∏</button>
    </div>

    <button class="btn primary" id="addBtn">+ –î–æ–¥–∞—Ç–∏</button>
  </div>
</header>

<main class="container">
  <div class="summary" id="summary">üéû –£ –ø–ª–∞–Ω–∞—Ö: 0 | ‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ: 0</div>
  <div class="cols">
    <section>
      <h2 id="todoTitle">üé¨ –•–æ—á—É –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</h2>
      <div class="sub" id="todoSub">–§—ñ–ª—å–º–∏, —è–∫—ñ –ø–ª–∞–Ω—É—î—à –ø–æ–¥–∏–≤–∏—Ç–∏—Å—å</div>
      <div id="todo" class="list"></div>
    </section>
    <section>
      <h2 id="doneTitle">‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ</h2>
      <div class="sub" id="doneSub">–§—ñ–ª—å–º–∏, —è–∫—ñ —Ç–∏ –≤–∂–µ –ø–æ–¥–∏–≤–∏–≤—Å—è</div>
      <div id="done" class="list"></div>
    </section>
  </div>

  <section class="recent">
    <details id="favBox" open>
      <summary id="favSummary">üåü –£–ª—é–±–ª–µ–Ω—ñ —Ñ—ñ–ª—å–º–∏</summary>
      <div id="favs" class="list" style="margin-top:10px; max-height:40vh;"></div>
    </details>
  </section>

  <section>
    <h3 class="section-h3" id="tmdbTitle" style="display:none">üîé –ó–Ω–∞–π–¥–µ–Ω–æ —É TMDB</h3>
    <div id="tmdbResults" class="list" style="display:none"></div>
  </section>
</main>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó -->
<div class="backdrop" id="authModal">
  <div class="modal" style="width:min(420px,92vw)">
    <h3 id="authTitle">–£–≤—ñ–π—Ç–∏</h3>

    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <button class="btn primary" id="authTabLogin">–£–≤—ñ–π—Ç–∏</button>
      <button class="btn" id="authTabRegister">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
    </div>

    <div class="grid">
      <div>
        <label id="authEmailLabel" for="authEmail">Email</label>
        <input
          id="authEmail"
          type="email"
          required
          minlength="3"
          maxlength="200"
        />
      </div>

      <div id="authNicknameRow" style="display:none;">
        <label id="authNicknameLabel" for="authNickname">–ù—ñ–∫</label>
        <input
          id="authNickname"
          type="text"
          minlength="3"
          maxlength="30"
        />
      </div>

      <div>
        <label id="authPasswordLabel" for="authPassword">–ü–∞—Ä–æ–ª—å</label>
        <input
          id="authPassword"
          type="password"
          required
          minlength="6"
          maxlength="200"
        />
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
        <button class="btn" id="authCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn primary" id="authSubmit">OK</button>
      </div>
    </div>
  </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è/—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å–º—É -->
<div class="backdrop" id="modal">
  <div class="modal">
    <h3 id="mTitle">–î–æ–¥–∞—Ç–∏ —Ñ—ñ–ª—å–º</h3>
    <div class="grid">
      <div class="grid-2">
        <div><label id="labelTitle">–ù–∞–∑–≤–∞</label><input id="fTitle" /></div>
        <div><label id="labelYear">–†—ñ–∫</label><input id="fYear" type="number" min="1888" max="2100" /></div>
      </div>
      <div class="grid-2">
        <div><label id="labelGenre">–ñ–∞–Ω—Ä</label><input id="fGenre" placeholder="–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞, –î—Ä–∞–º–∞..." /></div>
        <div><label id="labelRating">–û—Ü—ñ–Ω–∫–∞ (0‚Äì5)</label><input id="fRating" type="number" min="0" max="5" value="0" /></div>
      </div>
      <div class="grid-2">
        <div><label id="labelPoster">Poster URL (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label><input id="fPoster" placeholder="https://..." /></div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:20px">
          <input id="fWatched" type="checkbox" />
          <label for="fWatched" id="labelWatched">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ</label>
        </div>
      </div>
      <div><label id="labelComment">–ö–æ–º–µ–Ω—Ç–∞—Ä</label><textarea id="fComment" placeholder="–í—Ä–∞–∂–µ–Ω–Ω—è..."></textarea></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn primary" id="save">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ "–ø–æ–∑–Ω–∞—á–∏—Ç–∏ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏–º" -->
<div class="backdrop" id="mini">
  <div class="modal" style="width:min(420px,92vw)">
    <h3 id="mwTitle">–ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ</h3>
    <div class="grid">
      <div><label id="mwLabelRating">–û—Ü—ñ–Ω–∫–∞ (0‚Äì5)</label><input id="mwRating" type="number" min="0" max="5" value="5"/></div>
      <div><label id="mwLabelComment">–ö–æ–º–µ–Ω—Ç–∞—Ä (–æ–ø—Ü—ñ–π–Ω–æ)</label><textarea id="mwComment" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ –≤—Ä–∞–∂–µ–Ω–Ω—è..."></textarea></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="mwCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn primary" id="mwOk">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">–ó–±–µ—Ä–µ–∂–µ–Ω–æ</div>

<script>
const API = '/api/movies';
const $ = s => document.querySelector(s);

const todo = $('#todo');
const done = $('#done');
const favs = $('#favs');

// –ï–ª–µ–º–µ–Ω—Ç–∏ –º–æ–¥–∞–ª–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
const authModal       = $('#authModal');
const authBtn         = $('#authBtn');
const authTitle       = $('#authTitle');
const authTabLogin    = $('#authTabLogin');
const authTabRegister = $('#authTabRegister');
const authEmail       = $('#authEmail');
const authNicknameRow = $('#authNicknameRow');
const authNickname    = $('#authNickname');
const authPassword    = $('#authPassword');
const authCancelBtn   = $('#authCancel');
const authSubmitBtn   = $('#authSubmit');

let authMode = 'login'; // 'login' –∞–±–æ 'register'

let editing = null;
let markTarget = null;
let currentUser = null;

const placeholder = 'https://placehold.co/200x300?text=%F0%9F%8E%AC';

/* ===== I18N ===== */
const I18N = {
  uk: {
    subtitle: '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –±–∞–∑–∞ —Ñ—ñ–ª—å–º—ñ–≤',
    searchPlaceholder: '–ü–æ—à—É–∫ —É –Ω–∞–∑–≤—ñ/–∂–∞–Ω—Ä—ñ/—Ä–æ—Ü—ñ...',
    summary: (plans, seen) => `üéû –£ –ø–ª–∞–Ω–∞—Ö: ${plans} | ‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ: ${seen}`,
    todoTitle: 'üé¨ –•–æ—á—É –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏',
    todoSub: '–§—ñ–ª—å–º–∏, —è–∫—ñ –ø–ª–∞–Ω—É—î—à –ø–æ–¥–∏–≤–∏—Ç–∏—Å—å',
    doneTitle: '‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ',
    doneSub: '–§—ñ–ª—å–º–∏, —è–∫—ñ —Ç–∏ –≤–∂–µ –ø–æ–¥–∏–≤–∏–≤—Å—è',
    favSummary: 'üåü –£–ª—é–±–ª–µ–Ω—ñ —Ñ—ñ–ª—å–º–∏',
    tmdbTitle: 'üîé –ó–Ω–∞–π–¥–µ–Ω–æ —É TMDB',
    btnAdd: '+ –î–æ–¥–∞—Ç–∏',
    btnMarkWatched: '‚úî –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ',
    btnBackToPlan: '‚Ü©Ô∏é –í –ø–ª–∞–Ω',
    btnPlanFromTmdb: '+ –£ –ø–ª–∞–Ω',
    btnFavFromTmdb: '‚òÖ –î–æ —É–ª—é–±–ª–µ–Ω–∏—Ö',
    emptyList: '–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ',
    noGenre: '–ë–µ–∑ –∂–∞–Ω—Ä—É',
    commentPrefix: '–ö–æ–º–µ–Ω—Ç–∞—Ä: ',
    toastSaved: '–ó–±–µ—Ä–µ–∂–µ–Ω–æ',
    toastMarkedWatched: '–ü–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ',
    toastBackToPlan: '–ü–æ–≤–µ—Ä–Ω–µ–Ω–æ —É –ø–ª–∞–Ω',
    toastAddedPlan: '–î–æ–¥–∞–Ω–æ –≤ –ø–ª–∞–Ω',
    toastAddedFav: '–î–æ–¥–∞–Ω–æ –¥–æ —É–ª—é–±–ª–µ–Ω–∏—Ö',
    authLoginTitle: '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è',
    authBtnLogin: '–£–≤—ñ–π—Ç–∏',
    authBtnLogout: '–í–∏–π—Ç–∏',
    authEmailLabel: 'Email',
    authPasswordLabel: '–ü–∞—Ä–æ–ª—å',
    authToastLoggedOut: '–í–∏—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ',
    authToastRegistered: '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞ üéâ',
    authToastLoggedIn: '–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π ‚úÖ',
    authToastFill: '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å',
    authToastPasswordShort: '–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤',
    authErrorRegister: '–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó',
    authErrorLogin: '–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å',
    authErrorNetwork: '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ',
    modalAddTitle: '–î–æ–¥–∞—Ç–∏ —Ñ—ñ–ª—å–º',
    modalEditTitle: '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å–º',
    modalSave: '–ó–±–µ—Ä–µ–≥—Ç–∏',
    modalCancel: '–°–∫–∞—Å—É–≤–∞—Ç–∏',
    mwTitle: '–ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ',
    mwLabelRating: '–û—Ü—ñ–Ω–∫–∞ (0‚Äì5)',
    mwLabelComment: '–ö–æ–º–µ–Ω—Ç–∞—Ä (–æ–ø—Ü—ñ–π–Ω–æ)',
    mwOk: '–ì–æ—Ç–æ–≤–æ',
    mwCancel: '–°–∫–∞—Å—É–≤–∞—Ç–∏'
  },
  pl: {
    subtitle: 'osobista baza film√≥w',
    searchPlaceholder: 'Szukaj po tytule/gatunku/roku...',
    summary: (plans, seen) => `üéû W planach: ${plans} | ‚úÖ Obejrzane: ${seen}`,
    todoTitle: 'üé¨ Chcƒô obejrzeƒá',
    todoSub: 'Filmy, kt√≥re planujesz obejrzeƒá',
    doneTitle: '‚úÖ Obejrzane',
    doneSub: 'Filmy, kt√≥re ju≈º obejrza≈Çe≈õ',
    favSummary: 'üåü Ulubione filmy',
    tmdbTitle: 'üîé Znalezione w TMDB',
    btnAdd: '+ Dodaj',
    btnMarkWatched: '‚úî Obejrzane',
    btnBackToPlan: '‚Ü©Ô∏é Do planu',
    btnPlanFromTmdb: '+ Do planu',
    btnFavFromTmdb: '‚òÖ Do ulubionych',
    emptyList: 'Nic nie znaleziono',
    noGenre: 'Bez gatunku',
    commentPrefix: 'Komentarz: ',
    toastSaved: 'Zapisano',
    toastMarkedWatched: 'Oznaczono jako obejrzane',
    toastBackToPlan: 'Przeniesiono do planu',
    toastAddedPlan: 'Dodano do planu',
    toastAddedFav: 'Dodano do ulubionych',
    authLoginTitle: 'Logowanie',
    authBtnLogin: 'Zaloguj siƒô',
    authBtnLogout: 'Wyloguj',
    authEmailLabel: 'Email',
    authPasswordLabel: 'Has≈Ço',
    authToastLoggedOut: 'Wylogowano',
    authToastRegistered: 'Rejestracja udana üéâ',
    authToastLoggedIn: 'Logowanie udane ‚úÖ',
    authToastFill: 'Wpisz email i has≈Ço',
    authToastPasswordShort: 'Has≈Ço musi mieƒá min. 6 znak√≥w',
    authErrorRegister: 'B≈ÇƒÖd rejestracji',
    authErrorLogin: 'Nieprawid≈Çowy email lub has≈Ço',
    authErrorNetwork: 'B≈ÇƒÖd sieci',
    modalAddTitle: 'Dodaj film',
    modalEditTitle: 'Edytuj film',
    modalSave: 'Zapisz',
    modalCancel: 'Anuluj',
    mwTitle: 'Oznacz jako obejrzane',
    mwLabelRating: 'Ocena (0‚Äì5)',
    mwLabelComment: 'Komentarz (opcjonalnie)',
    mwOk: 'Gotowe',
    mwCancel: 'Anuluj'
  }
};

let currentLang = localStorage.getItem('lang') === 'pl' ? 'pl' : 'uk';
function dict(){ return I18N[currentLang]; }

/* ===== TOAST ===== */
function toast(msg){
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1400);
}

function extractApiError(data, fallback){
  if (!data) return fallback;
  if (Array.isArray(data.fieldErrors) && data.fieldErrors.length){
    return data.fieldErrors[0].message || fallback;
  }
  if (data.message) return data.message;
  if (data.error) return data.error;
  return fallback;
}

/* ===== –ó–Ü–†–ö–ò ===== */
function starString(n){
  return '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.slice(0, n) + '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'.slice(0, 5 - n);
}

/* ===== API HELPER (–∑ X-User-Id) ===== */
async function fetchJSON(url, { method = 'GET', body } = {}){
  const headers = {};
  if (body) headers['Content-Type'] = 'application/json';

  // –¥–æ–¥–∞—î–º–æ userId –¥–ª—è –±–µ–∫–µ–Ω–¥—É
  const uid = currentUser?.id || localStorage.getItem('userId');
  if (uid) headers['X-User-Id'] = uid;

  const r = await fetch(url, { method, headers, body });

  let data = null;
  if (r.status !== 204){
    data = await r.json().catch(() => null);
  }

  if (!r.ok){
    const fallback = currentLang === 'pl' ? 'B≈ÇƒÖd serwera' : '–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
    const msg = extractApiError(data, fallback);
    toast(msg);
    throw new Error(msg);
  }

  return data;
}


/* ===== –ú–û–î–ê–õ–ö–ò –§–Ü–õ–¨–ú–Ü–í ===== */
function openModal(m = null){
  editing = m;
  const d = dict();
  $('#mTitle').textContent = m ? d.modalEditTitle : d.modalAddTitle;
  $('#fTitle').value   = m?.title       ?? '';
  $('#fYear').value    = m?.year        ?? '';
  $('#fGenre').value   = m?.genre       ?? '';
  $('#fRating').value  = m?.rating      ?? 0;
  $('#fPoster').value  = m?.poster_url  ?? '';
  $('#fComment').value = m?.comment     ?? '';
  $('#fWatched').checked = !!m?.watched;
  $('#modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal(){
  $('#modal').classList.remove('show');
  document.body.style.overflow = '';
}

function openMini(movie){
  markTarget = movie;
  $('#mwRating').value = movie?.rating ?? 5;
  $('#mwComment').value = movie?.comment ?? '';
  $('#mini').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeMini(){
  $('#mini').classList.remove('show');
  document.body.style.overflow = '';
  markTarget = null;
}

/* ===== –ú–û–î–ê–õ–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á ===== */
function openAuthModal(mode = 'login'){
  authMode = mode;
  const d = dict();

  // –∑–∞–≥–æ–ª–æ–≤–æ–∫
  if (authTitle){
    if (mode === 'login'){
      authTitle.textContent = d.authLoginTitle;
    } else {
      authTitle.textContent = currentLang === 'pl' ? 'Rejestracja' : '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è';
    }
  }

  // –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –≤–∫–ª–∞–¥–æ–∫
  if (authTabLogin && authTabRegister){
    authTabLogin.classList.toggle('primary', mode === 'login');
    authTabRegister.classList.toggle('primary', mode === 'register');
  }

  // –ø–æ–∫–∞–∑/–ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –ø–æ–ª—è "–ù—ñ–∫" –ø—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
  if (authNicknameRow){
    authNicknameRow.style.display = mode === 'register' ? '' : 'none';
  }

  if (authEmail)    authEmail.value = currentUser?.email || '';
  if (authPassword) authPassword.value = '';
  if (authNickname) authNickname.value = '';

  if (authModal){
    authModal.classList.add('show');
  }
  document.body.style.overflow = 'hidden';
}

function closeAuthModal(){
  if (authModal){
    authModal.classList.remove('show');
  }
  document.body.style.overflow = '';
}


/* ===== UI –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á ===== */
function updateAuthUI(){
  const authBtn = document.getElementById('authBtn');
  const userEmailSpan = document.getElementById('userEmail');
  const d = dict();
  if (!authBtn || !userEmailSpan) return;

  if (currentUser){
    authBtn.textContent = d.authBtnLogout;
    // –ø–æ–∫–∞–∑—É—î–º–æ –Ω—ñ–∫, —è–∫—â–æ —î; —ñ–Ω–∞–∫—à–µ email
    const label = currentUser.nickname || currentUser.email || '';
    userEmailSpan.textContent = label;
    userEmailSpan.style.display = label ? 'inline' : 'none';
  } else {
    authBtn.textContent = d.authBtnLogin;
    userEmailSpan.textContent = '';
    userEmailSpan.style.display = 'none';
  }
}

/* ===== LOCALSTORAGE –ö–û–†–ò–°–¢–£–í–ê–ß–ê ===== */
function loadUserFromStorage(){
  const id       = localStorage.getItem('userId');
  const email    = localStorage.getItem('userEmail');
  const nickname = localStorage.getItem('userNickname');
  if (id){
    currentUser = {
      id,
      email: email || '',
      nickname: nickname || ''
    };
  } else {
    currentUser = null;
  }
  updateAuthUI();
}

/* ===== –û–ë–†–û–ë–ù–ò–ö–ò –ö–ù–û–ü–û–ö –§–Ü–õ–¨–ú–Ü–í ===== */
document.getElementById('addBtn').onclick = () => openModal();
document.getElementById('cancel').onclick = closeModal;

document.getElementById('q').oninput = () => render();

document.getElementById('mwCancel').onclick = closeMini;

document.getElementById('mwOk').onclick = async () => {
  const d = dict();
  const r = Number(document.getElementById('mwRating').value || 0);
  const c = document.getElementById('mwComment').value.trim();
  if (!markTarget) return closeMini();

  await fetchJSON(`${API}/${markTarget.id}`, {
    method:'PUT',
    body: JSON.stringify({
      watched:true,
      rating: Math.max(0, Math.min(5, Math.round(r))),
      comment:c
    })
  });

  closeMini();
  toast(d.toastMarkedWatched);
  render();
  loadFavs();
};

document.getElementById('save').onclick = async () => {
  const d = dict();

  const titleEl   = document.getElementById('fTitle');
  const yearEl    = document.getElementById('fYear');
  const genreEl   = document.getElementById('fGenre');
  const ratingEl  = document.getElementById('fRating');
  const commentEl = document.getElementById('fComment');
  const posterEl  = document.getElementById('fPoster');
  const watchedEl = document.getElementById('fWatched');

  const title   = titleEl.value.trim();
  const yearStr = yearEl.value.trim();
  const genre   = genreEl.value.trim();
  const rating  = Number(ratingEl.value || 0);
  const comment = commentEl.value.trim();
  const poster  = posterEl.value.trim();
  const watched = watchedEl.checked;

  // ===== –í–ê–õ–Ü–î–ê–¶–Ü–Ø =====

  // 1. title: required, 3‚Äì200 —Å–∏–º–≤–æ–ª—ñ–≤
  if (!title || title.length < 3 || title.length > 200){
    toast(currentLang === 'pl'
      ? 'Tytu≈Ç musi mieƒá 3‚Äì200 znak√≥w'
      : '–ù–∞–∑–≤–∞ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ –≤—ñ–¥ 3 –¥–æ 200 —Å–∏–º–≤–æ–ª—ñ–≤'
    );
    titleEl.focus();
    return;
  }

  // 2. year: —è–∫—â–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ, —Ç–æ —á–∏—Å–ª–æ –≤—ñ–¥ 1888 –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–æ–∫—É + 1
  let year = null;
  if (yearStr){
    const y = Number(yearStr);
    const current = new Date().getFullYear() + 1;
    if (!Number.isInteger(y) || y < 1888 || y > current){
      toast(currentLang === 'pl'
        ? `Rok musi byƒá liczbƒÖ od 1888 do ${current}`
        : `–†—ñ–∫ –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–º –≤—ñ–¥ 1888 –¥–æ ${current}`
      );
      yearEl.focus();
      return;
    }
    year = y;
  }

  // 3. rating: 0‚Äì5
  if (!Number.isFinite(rating) || rating < 0 || rating > 5){
    toast(currentLang === 'pl'
      ? 'Ocena musi byƒá w zakresie 0‚Äì5'
      : '–û—Ü—ñ–Ω–∫–∞ –º–∞—î –±—É—Ç–∏ –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ 0‚Äì5'
    );
    ratingEl.focus();
    return;
  }

  // 4. comment: –Ω–µ –±—ñ–ª—å—à–µ 1000 —Å–∏–º–≤–æ–ª—ñ–≤
  if (comment.length > 1000){
    toast(currentLang === 'pl'
      ? 'Komentarz nie mo≈ºe byƒá d≈Çu≈ºszy ni≈º 1000 znak√≥w'
      : '–ö–æ–º–µ–Ω—Ç–∞—Ä –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –¥–æ–≤—à–∏–º –∑–∞ 1000 —Å–∏–º–≤–æ–ª—ñ–≤'
    );
    commentEl.focus();
    return;
  }

  // 5. poster_url: —è–∫—â–æ —î ‚Äî –ø—Ä–∏–±–ª–∏–∑–Ω–æ –≤–∞–ª—ñ–¥–Ω–∏–π URL
  let poster_url = null;
  if (poster){
    try{
      new URL(poster);      // —è–∫—â–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π ‚Äî –∫–∏–Ω–µ –ø–æ–º–∏–ª–∫—É
      poster_url = poster;
    } catch{
      toast(currentLang === 'pl'
        ? 'Nieprawid≈Çowy adres URL plakatu'
        : '–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –∞–¥—Ä–µ—Å–∞ URL –ø–æ—Å—Ç–µ—Ä–∞'
      );
      posterEl.focus();
      return;
    }
  }

  // 6. –ë—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–æ (–æ–ø—Ü.): —è–∫—â–æ –Ω–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ, —Ä–µ–π—Ç–∏–Ω–≥ –º–∞—î –±—É—Ç–∏ 0
  if (!watched && rating > 0){
    toast(currentLang === 'pl'
      ? 'Nie mo≈ºesz wystawiƒá oceny, je≈õli film nie jest oznaczony jako obejrzany'
      : '–ù–µ–º–æ–∂–ª–∏–≤–æ —Å—Ç–∞–≤–∏—Ç–∏ –æ—Ü—ñ–Ω–∫—É, —è–∫—â–æ —Ñ—ñ–ª—å–º –Ω–µ –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏–π'
    );
    return;
  }

  // ===== –Ø–∫—â–æ –≤—Å–µ –æ–∫ ‚Äî —Ñ–æ—Ä–º—É—î–º–æ body —ñ —à–ª–µ–º–æ –Ω–∞ –±–µ–∫–µ–Ω–¥ =====
  const body = {
    title,
    year,
    genre,
    rating,
    comment,
    watched,
    poster_url
  };

  try{
    if (editing){
      await fetchJSON(`${API}/${editing.id}`, {
        method:'PUT',
        body: JSON.stringify(body)
      });
    } else {
      await fetchJSON(API, {
        method:'POST',
        body: JSON.stringify(body)
      });
    }

    closeModal();
    toast(d.toastSaved);
    render();
    loadFavs();
  } catch (e){
    console.error(e);
  }
};


/* ===== –°–ü–ò–°–ö–ò –§–Ü–õ–¨–ú–Ü–í ===== */
function heart(isFav){ return isFav ? '‚ô•' : '‚ô°'; }

function drawList(items, target){
  const d = dict();
  target.innerHTML = '';
  if (!items.length){
    target.innerHTML = `<div class="empty">${d.emptyList}</div>`;
    return;
  }

  items.forEach(m => {
    const el = document.createElement('article');
    el.className = 'movie' + (m.watched ? ' watched' : '');
    const poster = m.poster_url || placeholder;

    el.innerHTML = `
      <img class="poster" src="${poster}" alt="poster">
      <div>
        <div class="title">${m.title}</div>
        <div class="meta">üé• ${[m.genre || d.noGenre, m.year || '‚Äî'].filter(Boolean).join(' ‚Ä¢ ')}</div>
        ${m.genre ? '<div class="chip">'+m.genre+'</div>' : ''}
        <div class="meta">${m.comment ? (d.commentPrefix + m.comment) : ''}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="stars" title="–û—Ü—ñ–Ω–∏—Ç–∏">${starString(m.rating || 0)}</div>
        <button class="btn" data-toggle>${m.watched ? d.btnBackToPlan : d.btnMarkWatched}</button>
        <button class="btn" data-edt>‚úé</button>
        <button class="btn" data-del>üóë</button>
        <button class="heart ${m.favorite ? 'fav' : ''}" data-fav>${heart(m.favorite)}</button>
      </div>`;

    el.querySelector('[data-del]').onclick = async () => {
      if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')){
        await fetchJSON(`${API}/${m.id}`, { method:'DELETE' });
        render();
        loadFavs();
      }
    };

  el.querySelector('[data-edt]').onclick = () => openModal(m);

  el.querySelector('[data-toggle]').onclick = async () => {
      if (!m.watched){
        // —è–∫—â–æ —â–µ –Ω–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ ‚Äî –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º—ñ–Ω—ñ-–º–æ–¥–∞–ª–∫—É –∑ –æ—Ü—ñ–Ω–∫–æ—é
        openMini(m);
      } else {
        // —è–∫—â–æ –≤–∂–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤ –ø–ª–∞–Ω
        // –í–ê–ñ–õ–ò–í–û: —Å–∫–∏–¥–∞—î–º–æ rating —É 0, —â–æ–± –Ω–µ –ª–∞–º–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ –±–µ–∫–µ–Ω–¥–∞
        await fetchJSON(`${API}/${m.id}`, {
          method:'PUT',
          body: JSON.stringify({ watched: false, rating: 0 })
        });
        toast(d.toastBackToPlan);
        render();
        loadFavs();
      }
    };


    el.querySelector('.stars').onclick = async () => {
      // —è–∫—â–æ —Ñ—ñ–ª—å–º —â–µ –Ω–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ ‚Äî –Ω–µ –¥–∞—î–º–æ –º–æ–≤—á–∫–∏ —Å—Ç–∞–≤–∏—Ç–∏ –æ—Ü—ñ–Ω–∫—É
      if (!m.watched){
        toast(currentLang === 'pl'
          ? 'Najpierw oznacz film jako obejrzany'
          : '–°–ø–æ—á–∞—Ç–∫—É –ø–æ–∑–Ω–∞—á —Ñ—ñ–ª—å–º –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏–º'
        );
        return;
      }

      const v = Number(prompt(
        currentLang === 'pl' ? 'Ocena 0‚Äì5' : '–û—Ü—ñ–Ω–∫–∞ 0‚Äì5',
        m.rating || 0
      ));

      if (Number.isFinite(v) && v >= 0 && v <= 5){
        await fetchJSON(`${API}/${m.id}`, {
          method:'PUT',
          body: JSON.stringify({ rating: Math.round(v) })
        });
        render();
      }
    };


    el.querySelector('[data-fav]').onclick = async () => {
      await fetchJSON(`${API}/${m.id}/favorite`, {
        method:'PUT',
        body: JSON.stringify({ favorite: !m.favorite })
      });
      render();
      loadFavs();
    };

    target.appendChild(el);
  });
}

async function refreshSummary(){
  const d = dict();
  const all = await fetchJSON(API);
  const plans = all.filter(m => !m.watched).length;
  const seen  = all.filter(m =>  m.watched).length;
  document.getElementById('summary').textContent = d.summary(plans, seen);
}

/* ===== TMDB ===== */
const tmdbBox   = document.getElementById('tmdbResults');
const tmdbTitleEl = document.getElementById('tmdbTitle');

function drawTmdb(results){
  const d = dict();
  if (!results.length){
    tmdbBox.style.display = 'none';
    tmdbTitleEl.style.display = 'none';
    tmdbBox.innerHTML = '';
    return;
  }

  tmdbTitleEl.style.display = '';
  tmdbBox.style.display = '';
  tmdbBox.innerHTML = '';

  results.forEach(m => {
    const el = document.createElement('article');
    el.className = 'movie';
    const poster = m.poster_url || 'https://placehold.co/200x300?text=TMDB';

    el.innerHTML = `
      <img class="poster" src="${poster}" alt="">
      <div>
        <div class="title">${m.title}</div>
        <div class="meta">${m.year || '‚Äî'}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" data-plan>${d.btnPlanFromTmdb}</button>
        <button class="btn primary" data-fav>${d.btnFavFromTmdb}</button>
      </div>`;

    el.querySelector('[data-plan]').onclick = async () => {
      await fetchJSON('/api/tmdb/add', {
        method:'POST',
        body: JSON.stringify({ tmdb_id: m.tmdb_id, watched:false, favorite:false })
      });
      toast(d.toastAddedPlan);
      render();
      loadFavs();
    };

    el.querySelector('[data-fav]').onclick = async () => {
      await fetchJSON('/api/tmdb/add', {
        method:'POST',
        body: JSON.stringify({ tmdb_id: m.tmdb_id, watched:false, favorite:true })
      });
      toast(d.toastAddedFav);
      render();
      loadFavs();
    };

    tmdbBox.appendChild(el);
  });
}

async function searchTmdb(q){
  if (!q || q.length < 2){
    tmdbBox.style.display = 'none';
    tmdbTitleEl.style.display = 'none';
    tmdbBox.innerHTML = '';
    return;
  }
  const res = await fetch(`/api/tmdb/search?q=${encodeURIComponent(q)}`).then(r => r.json());
  drawTmdb(res);
}

/* ===== –†–ï–ù–î–ï–† ===== */
async function render(){
  const q = document.getElementById('q').value.trim();
  const allItems = await fetchJSON(API);

  drawList(allItems.filter(m => !m.watched), todo);
  drawList(allItems.filter(m =>  m.watched), done);

  refreshSummary();
  searchTmdb(q);
}

async function loadFavs(){
  const items = await fetchJSON(`${API}/favorites`);
  drawList(items, favs);
}

/* ===== –õ–û–ì–Ü–ù / –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø ===== */

// –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª–∫—É
if (authCancelBtn){
  authCancelBtn.onclick = closeAuthModal;
}

// –ö–Ω–æ–ø–∫–∞ —É —à–∞–ø—Ü—ñ (–£–≤—ñ–π—Ç–∏ / –í–∏–π—Ç–∏)
if (authBtn){
  authBtn.onclick = () => {
    const d = dict();
    if (currentUser){
      // LOGOUT
      currentUser = null;
      localStorage.removeItem('userId');
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userNickname');
      updateAuthUI();
      toast(d.authToastLoggedOut);
      render();
      loadFavs();
    } else {
      openAuthModal('login');
    }
  };
}

// –ü–µ—Ä–µ–º–∏–∫–∞—á—ñ –≤–∫–ª–∞–¥–æ–∫
if (authTabLogin){
  authTabLogin.onclick = () => openAuthModal('login');
}
if (authTabRegister){
  authTabRegister.onclick = () => openAuthModal('register');
}

// –ö–Ω–æ–ø–∫–∞ OK (–ª–æ–≥—ñ–Ω –∞–±–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è)
if (authSubmitBtn){
  authSubmitBtn.onclick = async () => {
    const d = dict();
    const email = authEmail ? authEmail.value.trim() : '';
    const password = authPassword ? authPassword.value : '';
    const nickInput = authNickname; // –º–æ–∂–µ –±—É—Ç–∏ null

    // ===== –ë–ê–ó–û–í–ê –ü–ï–†–ï–í–Ü–†–ö–ê –ù–ê –ó–ê–ü–û–í–ù–ï–ù–Ü–°–¢–¨ =====
    if (!email || !password){
      toast(d.authToastFill);
      if (!email && authEmail) authEmail.focus();
      else if (authPassword) authPassword.focus();
      return;
    }

    // ===== –í–ê–õ–Ü–î–ù–ò–ô EMAIL =====
    // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ HTML5-–ø–µ—Ä–µ–≤—ñ—Ä–∫—É
    if (authEmail && !authEmail.checkValidity()){
      toast(currentLang === 'pl'
        ? 'Niepoprawny adres email'
        : '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email'
      );
      authEmail.focus();
      return;
    }

    // –ù–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫ —Å–≤–æ—è –ø—Ä–æ—Å—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ (—è–∫—â–æ —Ç–∏–ø –Ω–µ email)
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)){
      toast(currentLang === 'pl'
        ? 'Niepoprawny adres email'
        : '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email'
      );
      if (authEmail) authEmail.focus();
      return;
    }

    // ===== –ü–ê–†–û–õ–¨: 6‚Äì200 —Å–∏–º–≤–æ–ª—ñ–≤ =====
    if (password.length < 6 || password.length > 200){
      toast(d.authToastPasswordShort);
      if (authPassword) authPassword.focus();
      return;
    }

    // ===== –ù–Ü–ö (—Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó) =====
    let nickname = '';
    if (authMode === 'register'){
      if (nickInput){
        nickname = nickInput.value.trim();
      }
      if (!nickname){
        // –≥–µ–Ω–µ—Ä—É—î–º–æ –∑ email, —è–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–≤–µ–ª–∏
        nickname = (email.split('@')[0] || 'user').slice(0, 20);
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: 3‚Äì30 —Å–∏–º–≤–æ–ª—ñ–≤, —Ç—ñ–ª—å–∫–∏ –ª—ñ—Ç–µ—Ä–∞/—Ü–∏—Ñ—Ä–∞/_/-
      const nickRegex = /^[A-Za-z0-9_-]{3,30}$/;
      if (!nickRegex.test(nickname)){
        toast(currentLang === 'pl'
          ? 'Nick musi mieƒá 3‚Äì30 znak√≥w (litery, cyfry, -, _)'
          : '–ù—ñ–∫ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ 3‚Äì30 —Å–∏–º–≤–æ–ª—ñ–≤ (–ª–∞—Ç–∏–Ω—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏, -, _)'
        );
        if (nickInput) nickInput.focus();
        return;
      }
    }

    try{
      let user = null;

      if (authMode === 'login'){
        // ===== –í–•–Ü–î =====
        const res = await fetch('/api/login', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok){
          toast(data?.message || d.authErrorLogin);
          return;
        }
        user = {
          id: data.id,
          email: data.email || email,
          nickname: data.nickname || ''
        };
        toast(d.authToastLoggedIn);
      } else {
        // ===== –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø =====
        const res = await fetch('/api/register', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ email, password, nickname })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok){
          toast(data?.message || d.authErrorRegister);
          return;
        }
        user = {
          id: data.id,
          email: data.email || email,
          nickname: data.nickname || nickname
        };
        toast(d.authToastRegistered);
      }

      // ===== –ó–ë–ï–†–Ü–ì–ê–Ñ–ú–û –ö–û–†–ò–°–¢–£–í–ê–ß–ê –í LOCALSTORAGE =====
      currentUser = user;
      if (currentUser){
        localStorage.setItem('userId', currentUser.id);
        localStorage.setItem('userEmail', currentUser.email);
        localStorage.setItem('userNickname', currentUser.nickname || '');
      }
      updateAuthUI();
      closeAuthModal();
      render();
      loadFavs();
    } catch(err){
      console.error(err);
      toast(d.authErrorNetwork);
    }
  };
}

/* ===== –ü–ï–†–ï–ú–ò–ö–ê–ß –ú–û–í ===== */
function applyLang(){
  const d = dict();
  document.documentElement.lang = currentLang === 'pl' ? 'pl' : 'uk';

  const subtitleEl = document.getElementById('subtitle');
  if (subtitleEl) subtitleEl.textContent = d.subtitle;

  const q = document.getElementById('q');
  if (q) q.placeholder = d.searchPlaceholder;

  const todoTitle = document.getElementById('todoTitle');
  if (todoTitle) todoTitle.textContent = d.todoTitle;
  const todoSub = document.getElementById('todoSub');
  if (todoSub) todoSub.textContent = d.todoSub;

  const doneTitle = document.getElementById('doneTitle');
  if (doneTitle) doneTitle.textContent = d.doneTitle;
  const doneSub = document.getElementById('doneSub');
  if (doneSub) doneSub.textContent = d.doneSub;

  const favSummary = document.getElementById('favSummary');
  if (favSummary) favSummary.textContent = d.favSummary;

  if (tmdbTitleEl) tmdbTitleEl.textContent = d.tmdbTitle;

  document.getElementById('mTitle').textContent = editing ? d.modalEditTitle : d.modalAddTitle;
  document.getElementById('cancel').textContent = d.modalCancel;
  document.getElementById('save').textContent = d.modalSave;

  document.getElementById('mwTitle').textContent = d.mwTitle;
  document.getElementById('mwLabelRating').textContent = d.mwLabelRating;
  document.getElementById('mwLabelComment').textContent = d.mwLabelComment;
  document.getElementById('mwCancel').textContent = d.mwCancel;
  document.getElementById('mwOk').textContent = d.mwOk;

  // ===== –¢–µ–∫—Å—Ç–∏ –≤ –º–æ–¥–∞–ª—Ü—ñ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó =====
  const authTitleEl = document.getElementById('authTitle');
  if (authTitleEl){
    authTitleEl.textContent =
      authMode === 'register'
        ? (currentLang === 'pl' ? 'Rejestracja' : '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è')
        : d.authLoginTitle;
  }

  const aEmailLabel = document.getElementById('authEmailLabel');
  if (aEmailLabel) aEmailLabel.textContent = d.authEmailLabel;

  const aPassLabel = document.getElementById('authPasswordLabel');
  if (aPassLabel) aPassLabel.textContent = d.authPasswordLabel;

  const aNickLabel = document.getElementById('authNicknameLabel');
  if (aNickLabel) aNickLabel.textContent =
    currentLang === 'pl' ? 'Nick' : '–ù—ñ–∫';

  const aCancel = document.getElementById('authCancel');
  if (aCancel) aCancel.textContent = d.modalCancel;

  const tabLogin = document.getElementById('authTabLogin');
  if (tabLogin) tabLogin.textContent = d.authBtnLogin;

  const tabReg = document.getElementById('authTabRegister');
  if (tabReg) tabReg.textContent =
    currentLang === 'pl' ? 'Rejestracja' : '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è';

  const submit = document.getElementById('authSubmit');
  if (submit) submit.textContent = 'OK';

  const addBtn = document.getElementById('addBtn');
  if (addBtn) addBtn.textContent = d.btnAdd;

  // –æ–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É —É —à–∞–ø—Ü—ñ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –ª–æ–≥—ñ–Ω—É
  updateAuthUI();

  // –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –º–æ–≤–∏
  document.getElementById('langUk').classList.toggle('active', currentLang === 'uk');
  document.getElementById('langPl').classList.toggle('active', currentLang === 'pl');
}


document.getElementById('langUk').onclick = () => {
  currentLang = 'uk';
  localStorage.setItem('lang', 'uk');
  applyLang();
  render();
  loadFavs();
};

document.getElementById('langPl').onclick = () => {
  currentLang = 'pl';
  localStorage.setItem('lang', 'pl');
  applyLang();
  render();
  loadFavs();
};

/* ===== –°–¢–ê–†–¢ ===== */
loadUserFromStorage();
applyLang();
render();
loadFavs();
</script>

</body>
</html>
